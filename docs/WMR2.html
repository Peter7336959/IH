<!DOCTYPE html>
<html lang="zh-TW">
<head>
<style type="text/css">
.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
}
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.left {
  text-align: left;
}
.right {
  text-align: right;
}
.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.sng {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.def {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
    <meta charset="UTF-8">
    <title>完全混合模式暴露濃度計算與風險評估</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 20px;
            display: flex;
            background-color: #f5f7f9;
        }
        .main-content {
            width: 70%;
            padding-right: 20px;
        }
        .sidebar {
            width: 30%;
            padding-left: 20px;
            border-left: 1px solid #ccc;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
        }
        input, select {
            width: 150px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: bold;
        }
        button#print {
            background-color: #008CBA;
        }
        button:hover {
            opacity: 0.9;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .risk-level-1 { background-color: #90EE90; }
        .risk-level-2 { background-color: #FFFFE0; }
        .risk-level-3 { background-color: #FFD580; }
        .risk-level-4 { background-color: #FF6347; }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .mode-params {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        #concentration_plot {
            margin-top: 20px;
            height: 300px;
        }
    </style>
</head>
<body>

<div class="main-content">
    <h1>完全混合模式暴露濃度計算與風險評估</h1>
    
    <div class="form-section">
        <h2>基本參數設定</h2>
        <div class="input-group">
            <label for="room_volume">房間體積 V (m³):</label>
            <input type="number" id="room_volume" value="50" step="0.1">
        </div>
        <div class="input-group">
            <label for="ventilation_rate">通風率 Q (m³/min):</label>
            <input type="number" id="ventilation_rate" value="5" step="0.1">
        </div>
        <div class="input-group">
            <label for="simulation_time">模擬時間 (分鐘):</label>
            <input type="number" id="simulation_time" value="480" step="1">
        </div>
        <div class="input-group">
            <label for="temperature">溫度 T (°C):</label>
            <input type="number" id="temperature" value="25" step="0.1">
        </div>
        <div class="input-group">
            <label for="molecular_weight">分子量 MW (g/mol):</label>
            <input type="number" id="molecular_weight" value="100" step="0.1">
        </div>
    </div>
    
    <div class="form-section">
        <h2>暴露限值設定</h2>
        <div class="input-group">
            <label for="tw_limit">TWA (8小時) 限值:</label>
            <input type="number" id="tw_limit" value="100" step="0.1">
            <select id="tw_unit">
                <option value="mg_m3">mg/m³</option>
                <option value="ppm">ppm</option>
            </select>
        </div>
        <div class="input-group">
            <label for="stel_limit">STEL (15分鐘) 限值:</label>
            <input type="number" id="stel_limit" value="150" step="0.1">
            <select id="stel_unit">
                <option value="mg_m3">mg/m³</option>
                <option value="ppm">ppm</option>
            </select>
        </div>
        <div class="input-group">
            <label for="idlh_limit">IDLH 限值:</label>
            <input type="number" id="idlh_limit" value="500" step="0.1">
            <select id="idlh_unit">
                <option value="mg_m3">mg/m³</option>
                <option value="ppm">ppm</option>
            </select>
        </div>
        <div class="input-group">
            <label for="oel_limit">OEL 限值:</label>
            <input type="number" id="oel_limit" value="100" step="0.1">
            <select id="oel_unit">
                <option value="mg_m3">mg/m³</option>
                <option value="ppm">ppm</option>
            </select>
        </div>
    </div>
    
    <div class="form-section">
        <h2>計算功能選擇</h2>
        <select id="calculation_mode" onchange="showFormula()">
            <option value="periodic">功能1：週期性運轉時間濃度</option>
            <option value="backpressure">功能2：考慮背壓時間濃度</option>
            <option value="exponential">功能3：排放指數遞減時間濃度</option>
        </select>
        
        <div id="formula_display" style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <p>選擇計算模式後顯示公式</p>
        </div>
        
        <div id="periodic_params" class="mode-params" style="display: none; margin-top: 15px;">
            <h3>週期性運轉參數</h3>
            <div class="input-group">
                <label for="emission_rate">排放率 G (mg/min):</label>
                <input type="number" id="emission_rate" value="1000" step="1">
            </div>
            <div class="input-group">
                <label for="cycle_on">運轉時間 (分鐘):</label>
                <input type="number" id="cycle_on" value="30" step="1">
            </div>
            <div class="input-group">
                <label for="cycle_off">停止時間 (分鐘):</label>
                <input type="number" id="cycle_off" value="30" step="1">
            </div>
        </div>
        
        <div id="backpressure_params" class="mode-params" style="display: none; margin-top: 15px;">
            <h3>背壓效應參數</h3>
            <div class="input-group">
                <label for="area">蒸發面積 A (m²):</label>
                <input type="number" id="area" value="2" step="0.1">
            </div>
            <div class="input-group">
                <label for="saturation_vapor_pressure">飽和蒸氣壓 Pv (Pa):</label>
                <input type="number" id="saturation_vapor_pressure" value="2000" step="1">
            </div>
            <div class="input-group">
                <label for="initial_concentration">初始濃度 C0 (mg/m³):</label>
                <input type="number" id="initial_concentration" value="0" step="0.1">
            </div>
        </div>
        
        <div id="exponential_params" class="mode-params" style="display: none; margin-top: 15px;">
            <h3>指數遞減參數</h3>
            <div class="input-group">
                <label for="initial_emission">初始排放率 G0 (mg/min):</label>
                <input type="number" id="initial_emission" value="1000" step="1">
            </div>
            <div class="input-group">
                <label for="surface_volume_ratio">表面積體積比 SA/VOL:</label>
                <input type="number" id="surface_volume_ratio" value="0.1" step="0.01">
            </div>
            <div class="input-group">
                <label for="initial_mass">初始質量 M0 (mg):</label>
                <input type="number" id="initial_mass" value="5000" step="1">
            </div>
        </div>
        
        <button onclick="calculate()">計算</button>
        <button id="print" onclick="window.print()">列印報告</button>
    </div>
    
    <div id="results" style="display: none;">
        <h2>計算結果</h2>
        <div id="concentration_plot">
            <canvas id="chart"></canvas>
        </div>
        
        <h3>暴露風險評估</h3>
        <table id="risk_table">
            <tr>
                <th>暴露指標</th>
                <th>限值</th>
                <th>計算值</th>
                <th>風險等級</th>
                <th>說明</th>
            </tr>
        </table>
        
        <h3>建議控制措施</h3>
        <div id="control_measures"></div>
    </div>
</div>

<div class="sidebar">
    <h2>暴露空間模式示意圖</h2>
    <img src="images/BOX.png" alt="暴露空間模式示意圖" style="max-width: 100%;">
    
    <div style="margin-top: 20px; padding: 15px; background-color: #fff4e6; border-radius: 8px;">
        <h3>風險等級說明</h3>
        <p><span style="background-color: #90EE90; padding: 2px 5px;">等級 1</span>: 低風險</p>
        <p><span style="background-color: #FFFFE0; padding: 2px 5px;">等級 2</span>: 中等風險</p>
        <p><span style="background-color: #FFD580; padding: 2px 5px;">等級 3</span>: 高風險</p>
        <p><span style="background-color: #FF6347; padding: 2px 5px;">等級 4</span>: 極高風險</p>
    </div>
</div>

<script>
// 全域變數用於儲存圖表物件
let concentrationChart = null;

// 顯示所選模式的公式和參數
function showFormula() {
    var mode = document.getElementById("calculation_mode").value;
    document.querySelectorAll(".mode-params").forEach(function(el) {
        el.style.display = "none";
    });
    
    if (mode === "periodic") {
        document.getElementById("formula_display").innerHTML = 
            "<p><strong>週期性運轉公式：</strong></p>" +
            "<p>排放階段: C(t) = G (1 - e^{-Q/V * t})</p>" +
            "<p>衰減階段: C(t) = C0 · e^{-Q/V * t}</p>";
        document.getElementById("periodic_params").style.display = "block";
    } else if (mode === "backpressure") {
        document.getElementById("formula_display").innerHTML = 
            "<p><strong>背壓效應公式：</strong></p>" +
            "<p>G = 1000 ⋅ Kt ⋅ MW ⋅ A ⋅ (Pv − PvB) / (R ⋅ TL)</p>" +
            "<p>Kt = 0.5 ⋅ (18.0/MW)^{1/3}</p>" +
            "<p>PvB = C ⋅ Tair ⋅ 8.2 × 10^{-5} / MW</p>";
        document.getElementById("backpressure_params").style.display = "block";
    } else if (mode === "exponential") {
        document.getElementById("formula_display").innerHTML = 
            "<p><strong>指數遞減公式：</strong></p>" +
            "<p>G(t) = G0 × exp(−αt)</p>" +
            "<p>α = 0.000524Pv + 0.0108 ⋅ SA/VOL</p>" +
            "<p>C(t) = [αM0/(αV - Q)] [exp(-Q/V t) − exp(−αt)]</p>";
        document.getElementById("exponential_params").style.display = "block";
    }
}

// 溫度修正排放率函數
function temperatureAdjustedEmission(baseEmission, temperature) {
    // 使用Clausius-Clapeyron方程估算
    return baseEmission * Math.exp(4660 * (1/294.3 - 1/(temperature + 273.15)));
}

// 主計算函數
function calculate() {
    // 獲取基本參數
    var V = parseFloat(document.getElementById("room_volume").value);
    var Q = parseFloat(document.getElementById("ventilation_rate").value);
    var simTime = parseInt(document.getElementById("simulation_time").value);
    var T = parseFloat(document.getElementById("temperature").value);
    var MW = parseFloat(document.getElementById("molecular_weight").value);
    
    // 獲取模式特定參數
    var mode = document.getElementById("calculation_mode").value;
    var concentrations = [];
    var times = [];
    
    // 根據選擇的模式計算濃度
    if (mode === "periodic") {
        var G = parseFloat(document.getElementById("emission_rate").value);
        var cycleOn = parseInt(document.getElementById("cycle_on").value);
        var cycleOff = parseInt(document.getElementById("cycle_off").value);
        var cycleTotal = cycleOn + cycleOff;
        
        // 溫度修正排放率
        G = temperatureAdjustedEmission(G, T);
        
        var C = 0;
        for (var t = 1; t <= simTime; t++) {
            var cyclePosition = t % cycleTotal;
            if (cyclePosition === 0) cyclePosition = cycleTotal;
            
            if (cyclePosition <= cycleOn) {
                // 排放階段
                C = G * (1 - Math.exp(-Q/V * 1)) + C * Math.exp(-Q/V * 1);
            } else {
                // 衰減階段
                C = C * Math.exp(-Q/V * 1);
            }
            concentrations.push(C);
            times.push(t);
        }
    } else if (mode === "backpressure") {
        var A = parseFloat(document.getElementById("area").value);
        var Pv = parseFloat(document.getElementById("saturation_vapor_pressure").value);
        var C0 = parseFloat(document.getElementById("initial_concentration").value);
        
        // 計算質量傳遞係數
        var Kt = 0.5 * Math.pow(18.0/MW, 1/3);
        var R = 8.314; // 氣體常數
        
        var C = C0;
        for (var t = 1; t <= simTime; t++) {
            // 計算背壓
            var PvB = C * (T + 273.15) * 8.2e-5 / MW;
            
            // 計算排放率
            var G = 1000 * Kt * MW * A * (Pv - PvB) / (R * (T + 273.15));
            
            // 溫度修正排放率
            G = temperatureAdjustedEmission(G, T);
            
            // 計算濃度
            C = G * (1 - Math.exp(-Q/V * 1)) + C * Math.exp(-Q/V * 1);
            concentrations.push(C);
            times.push(t);
        }
    } else if (mode === "exponential") {
        var G0 = parseFloat(document.getElementById("initial_emission").value);
        var SA_VOL = parseFloat(document.getElementById("surface_volume_ratio").value);
        var M0 = parseFloat(document.getElementById("initial_mass").value);
        var Pv = parseFloat(document.getElementById("saturation_vapor_pressure").value);
        
        // 溫度修正初始排放率
        G0 = temperatureAdjustedEmission(G0, T);
        
        // 計算蒸發速率常數
        var alpha = 0.000524 * Pv + 0.0108 * SA_VOL;
        
        var C = 0;
        for (var t = 1; t <= simTime; t++) {
            // 計算排放率
            var Gt = G0 * Math.exp(-alpha * t);
            
            // 計算濃度
            if (alpha * V !== Q) {
                C = (alpha * M0 / (alpha * V - Q)) * (Math.exp(-Q/V * t) - Math.exp(-alpha * t));
            } else {
                // 避免除以零的特殊情況
                C = (alpha * M0 * t / V) * Math.exp(-alpha * t);
            }
            concentrations.push(C);
            times.push(t);
        }
    }
    
    // 計算暴露指標
    var TWA = calculateTWA(concentrations, simTime);
    var STEL = calculateSTEL(concentrations);
    
    // 獲取限值
    var TWLimit = parseFloat(document.getElementById("tw_limit").value);
    var STELLimit = parseFloat(document.getElementById("stel_limit").value);
    var IDLHLimit = parseFloat(document.getElementById("idlh_limit").value);
    var OELLimit = parseFloat(document.getElementById("oel_limit").value);
    
    // 評估風險
    var riskAssessment = assessRisk(TWA, STEL, concentrations, TWLimit, STELLimit, IDLHLimit, OELLimit);
    
    // 顯示結果
    displayResults(times, concentrations, riskAssessment);
    
    document.getElementById("results").style.display = "block";
}

// 計算TWA
function calculateTWA(concentrations, simTime) {
    var total = 0;
    var count = Math.min(480, concentrations.length);
    for (var i = 0; i < count; i++) {
        total += concentrations[i];
    }
    return total / count;
}

// 計算STEL
function calculateSTEL(concentrations) {
    var maxSTEL = 0;
    for (var i = 0; i <= concentrations.length - 15; i++) {
        var sum = 0;
        for (var j = 0; j < 15; j++) {
            sum += concentrations[i + j];
        }
        var stel = sum / 15;
        if (stel > maxSTEL) maxSTEL = stel;
    }
    return maxSTEL;
}

// 風險評估
function assessRisk(TWA, STEL, concentrations, TWLimit, STELLimit, IDLHLimit, OELLimit) {
    var riskLevels = {
        idlh: 0,
        stel: 0,
        twa: 0,
        oel: 0
    };
    
    var descriptions = {
        idlh: "",
        stel: "",
        twa: "",
        oel: ""
    };
    
    var controlMeasures = "";
    
    // 檢查IDLH
    var maxConcentration = Math.max(...concentrations);
    if (maxConcentration >= IDLHLimit) {
        riskLevels.idlh = 4;
        descriptions.idlh = "超過IDLH限值，有立即生命危險";
        controlMeasures += "• 立即撤離暴露區域<br>• 使用自給式呼吸器<br>• 加強局部排氣通風<br>";
    } else {
        riskLevels.idlh = 1;
        descriptions.idlh = "低於IDLH限值";
    }
    
    // 檢查STEL
    if (STEL >= STELLimit) {
        riskLevels.stel = 4;
        descriptions.stel = "超過STEL限值，有健康危險";
        controlMeasures += "• 減少短期暴露時間<br>• 增加通風率<br>• 使用呼吸防護裝備<br>";
    } else if (STEL >= STELLimit / 2) {
        riskLevels.stel = 3;
        descriptions.stel = "接近STEL限值，需注意";
    } else {
        riskLevels.stel = 1;
        descriptions.stel = "低於STEL限值";
    }
    
    // 檢查TWA
    if (TWA >= TWLimit) {
        riskLevels.twa = 4;
        descriptions.twa = "超過TWA限值，長期暴露有健康風險";
        controlMeasures += "• 減少每日暴露時間<br>• 改善整體通風<br>• 定期健康檢查<br>";
    } else if (TWA >= TWLimit / 2) {
        riskLevels.twa = 3;
        descriptions.twa = "中等暴露水平，需監測";
    } else if (TWA >= TWLimit / 10) {
        riskLevels.twa = 2;
        descriptions.twa = "低暴露水平";
    } else {
        riskLevels.twa = 1;
        descriptions.twa = "非常低暴露水平";
    }
    
    // 檢查OEL
    if (TWA >= OELLimit) {
        riskLevels.oel = 4;
        descriptions.oel = "超過OEL限值，需採取控制措施";
        controlMeasures += "• 工程控制措施優先<br>• 行政管理控制<br>• 個人防護裝備<br>";
    } else if (TWA >= OELLimit / 2) {
        riskLevels.oel = 3;
        descriptions.oel = "接近OEL限值，需注意";
    } else if (TWA >= OELLimit / 10) {
        riskLevels.oel = 2;
        descriptions.oel = "低於OEL限值一半";
    } else {
        riskLevels.oel = 1;
        descriptions.oel = "遠低於OEL限值";
    }
    
    if (controlMeasures === "") {
        controlMeasures = "當前暴露水平在可接受範圍內，維持現有控制措施即可。";
    }
    
    return {
        TWA: TWA,
        STEL: STEL,
        maxConcentration: maxConcentration,
        riskLevels: riskLevels,
        descriptions: descriptions,
        controlMeasures: controlMeasures
    };
}

// 顯示結果
function displayResults(times, concentrations, riskAssessment) {
    // 繪製濃度趨勢圖
    var ctx = document.getElementById('chart').getContext('2d');
    
    // 如果已有圖表，先銷毀
    if (concentrationChart) {
        concentrationChart.destroy();
    }
    
    // 建立新圖表
    concentrationChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: times,
            datasets: [{
                label: '濃度 (mg/m³)',
                data: concentrations,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '時間 (分鐘)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: '濃度 (mg/m³)'
                    },
                    beginAtZero: true
                }
            }
        }
    });
    
    // 顯示風險評估表格
    var riskTable = document.getElementById("risk_table");
    // 清空表格，保留標題行
    while (riskTable.rows.length > 1) {
        riskTable.deleteRow(1);
    }
    
    addRiskRow(riskTable, "IDLH", riskAssessment.maxConcentration.toFixed(2), 
               riskAssessment.riskLevels.idlh, riskAssessment.descriptions.idlh, 
               document.getElementById("idlh_limit").value + " " + 
               document.getElementById("idlh_unit").value);
    
    addRiskRow(riskTable, "STEL (15分鐘)", riskAssessment.STEL.toFixed(2), 
               riskAssessment.riskLevels.stel, riskAssessment.descriptions.stel, 
               document.getElementById("stel_limit").value + " " + 
               document.getElementById("stel_unit").value);
    
    addRiskRow(riskTable, "TWA (8小時)", riskAssessment.TWA.toFixed(2), 
               riskAssessment.riskLevels.twa, riskAssessment.descriptions.twa, 
               document.getElementById("tw_limit").value + " " + 
               document.getElementById("tw_unit").value);
    
    addRiskRow(riskTable, "OEL", riskAssessment.TWA.toFixed(2), 
               riskAssessment.riskLevels.oel, riskAssessment.descriptions.oel, 
               document.getElementById("oel_limit").value + " " + 
               document.getElementById("oel_unit").value);
    
    // 顯示控制措施
    document.getElementById("control_measures").innerHTML = riskAssessment.controlMeasures;
}

// 添加風險行到表格
function addRiskRow(table, indicator, value, riskLevel, description, limit) {
    var row = table.insertRow();
    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);
    
    cell1.innerHTML = indicator;
    cell2.innerHTML = limit;
    cell3.innerHTML = value;
    cell4.innerHTML = riskLevel;
    cell5.innerHTML = description;
    
    // 根據風險等級添加顏色
    row.className = "risk-level-" + riskLevel;
}

// 初始化顯示
showFormula();
</script>

</body>
</html>
